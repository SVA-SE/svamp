This report was requested by __`r paste(as.character(toupper(report_data_object()$firstname)), toupper(as.character(report_data_object()$lastname)), sep = " ")`__ to investigate the PPN n. __`r unique(as.character(report_data_object()$ppn))`__         


```{r Outbreak, warning = FALSE, message = FALSE, echo = FALSE, results = 'asis'}

farms_RT90 <- report_data_object()$result$farms_RT90
ppn <- report_data_object()$ppn

outbreak <- subset(farms_RT90, farms_RT90$Ppn == ppn)

```

<br>

### 1. GEOGRAPHIC LOCATION

* The PPN under investigation is located in __`r toupper(paste(outbreak@data$Lan))`__ within the municipality of __`r toupper(paste(outbreak@data$Kommun))`__ 

* The address of the PPN is __`r toupper(paste(outbreak@data$Adress,",", outbreak@data$Postnummer, "", outbreak@data$Kommun))`__


```{r PlotMap1, warning = FALSE, message = FALSE, echo = FALSE, results = 'asis', fig.height = 14, fig.width = 14}

NUTS_03M <- report_data_object()$NUTS_03M[
            report_data_object()$NUTS_03M$STAT_LEVL_ == 3, 1:2]
NUTS_03M@data$Lan <- report_data_object()$result$nuts_label$Swedish[
                       match(as.character(NUTS_03M@data$NUTS_ID),
                             report_data_object()$result$nuts_label$NUTS)]



# Check for points falling outside Swedish border

if(all(!is.na(over(outbreak, NUTS_03M)))) {
  
  lan <- over(outbreak,NUTS_03M)
  lan <- NUTS_03M[NUTS_03M@data$NUTS_ID == lan$NUTS_ID,]
  plot(NUTS_03M, axes = T)
  plot(lan, add = T, col = "yellow")


points(outbreak, pch = 19, col = "red", cex = 1)

# Add labels to the polygons

invisible(text(coordinates(NUTS_03M),
               labels = as.character(NUTS_03M@data$Lan), 
               cex = 0.8))

title(expression(paste("Geographic location of the PPN under investigation")))

legend("bottomright",
        cex = 1.3, 
        "PPN location", 
        pch = 19, 
        pt.cex = 1.2,
        col = "red",
        bty = "n")

} else {
   
  plot(1,1,col = "white")
  text(1,1,"Provided coordinates fall outside the Swedish borders")
}

```

The PPN is geolocated at the following coordinates:

```{r Coordinates, warning = FALSE, message = FALSE, echo = FALSE}

outbreak_WGS84 <- spTransform(outbreak, CRS("+init=epsg:4326"))
outbreak_SWEREF99 <- spTransform(outbreak_WGS84, CRS("+init=epsg:3006"))

df <- data.frame("RefSyst" = c("RT90", "WGS84", "SWEREF99"),
                 
                 "X" = c(as.integer(outbreak@coords[,1]),
                         outbreak_WGS84@coords[,1], 
                         outbreak_SWEREF99@coords[,1]),
                 
                 "Y" = c(as.integer(outbreak@coords[,2]),
                         outbreak_WGS84@coords[,2],
                         outbreak_SWEREF99@coords[,2]))

colnames(df) <- c("Reference system", "X coordinate", "Y coordinate")
                 
kable(df, digits=1, row.names = FALSE)   


```

****
<br>

```{r LeafletMap1, warning=FALSE, message=FALSE, echo = FALSE, fig.align='center',fig.width=8}

outbreak1 <- outbreak[ , c(1, 4, 8, 11, 41)]
outbreak1_wgs <- spTransform(outbreak1, CRS("+init=epsg:4326"))

LeafletMap1 <- leaflet(outbreak1_wgs) %>% addProviderTiles("CartoDB.Positron")

LeafletMap1 %>% addCircleMarkers(stroke = FALSE,
                                 fill = TRUE, 
                                 fillColor = "red")
```

****
<br>

### 2. NUMBER OF HERDS AND ANIMALS (for the investigated PPN)

```{r herds/anim_outbreak, results='asis', fig.height=4, fig.width=12, echo=FALSE}

PPN <- report_data_object()$result$PPN

outb.in.PPN <-  PPN[which(PPN$Ppn %in% outbreak@data$Ppn), ]

outb.in.PPN <- outb.in.PPN[!duplicated(outb.in.PPN [c("Ppn",
                                                      "Adress",
                                                      "Typ",
                                                      "Typ.1",
                                                      "tot_anim")]),]
counts <- table(outb.in.PPN$Typ)

# Draw the graph with herds/animals count for the outbreak

par(mfrow = c(1,2), mar=c(5.1, 4.8, 4.1, 2.1), 
    mgp=c(3.8, 1, 0), las=2)

width = ifelse(length(counts) == 1, 0.2, 0.8) #avoid big bar drawing when length=1

b1a <- barplot(counts,
               main = "Number of herds by species", 
               ylab = "Number of herds", 
               xlim = c(0, length(counts)),
               ylim = c(0, max(counts * 1.4)),
               width = width)

text(x = b1a, y = counts, label = counts, 
     pos = 3, cex = 0.8, col = "black")

if (all(is.na(outb.in.PPN$tot_anim))) {

    counts2 <- 0

    b1b <- barplot(counts2, 
               main = "Number of animals by species", 
               xaxt = "n", 
               xlab = "", 
               ylab = "", 
               col = "white", 
               border = NA, 
               sub =  "Number of animals is NA. See Excel file for details")

} else {

    outb.in.PPN <- outb.in.PPN [!is.na(outb.in.PPN$tot_anim),]

    counts2 <-tapply(outb.in.PPN$tot_anim, 
                     INDEX = outb.in.PPN$Typ, 
                     FUN = sum)
    
    width = ifelse(length(counts2) == 1, 0.2, 0.8)

    b1b <- barplot(counts2, 
               main = "Number of animals by species",
               ylab = "Number of animals", 
               ylim = c(0, max(counts2 * 1.4)),
               xlim = c(0, length(counts2)),
               width = width)

    text(x = b1b, y = counts2, label = counts2,
         pos = 3, cex = 0.8, col = "black")
}

```

****
<br>

### 3. OWNERS INFORMATION

```{r Match_Owners, results='asis', echo=FALSE}

index <- match(PPN$Ppn, outbreak@data$Ppn)
outbreak_own <- PPN[which(PPN$Ppn == outbreak@data$Ppn), ]
owners <- length(unique(outbreak_own$Namn))

```

The number of owners/reference persons for the PPN under investigation is: __`r owners`__

```{r OwnersData, results='asis', echo=FALSE}

colnames(outbreak_own)[c(33, 36, 37, 31)] <- c("Adress",
                                               "Postadress",
                                               "Telefonnummer",
                                               "Typ")

kable(unique(outbreak_own[,c(32, 33, 36, 37, 38, 39, 31)]),
      align = 'c', row.names = FALSE)

```

****
<br>

### 4. VETERINARY DISTRICTS INFORMATION

The 3 most closest veterinary districts (euclidean distance) from the investigated PPN position are: 

```{r VetDistrictDist, warning=FALSE, message=FALSE, echo = FALSE, results='asis'}

district_geo_RT90 <- report_data_object()$result$district_geo_RT90

# calculate euclidean distance from outbreak to vet disctrict
dist_vet <- spDistsN1(district_geo_RT90, outbreak, longlat = FALSE)/ 1000
dist_vet <- round(dist_vet, 3)
dist_vet <- cbind(district_geo_RT90@data[ , 2:6], dist_vet)
dist_vet <- dist_vet[order(dist_vet[, 6]), ]

# show only the three most closest
kable(head(dist_vet, 3), align = 'c', digits = 1, row.names = FALSE)

```


****

<br>

### 5. RESTRICTION ZONES

This section generates 3 circular restriction zones centered at the PPN's coordinates. If PPN coordinates were missing in the dataset, the circular buffers are centred on the provided coordinates. The zones have different radius: 

* 1 km (red zone)    
* 3 km (yellow zone)    
* 10 km (green zone)    

```{r Buffers, results = 'asis', echo = FALSE, warning = TRUE, message = TRUE}

#Buffers and Outbreak: Create multiple buffers
x <- coordinates(outbreak)[, 1] # Outbreak coord x
y <- coordinates(outbreak)[, 2] # Outbreak coord y

# So far working for 1 ppn per time
stopifnot(length(x) == 1 & length(y) == 1)

# Buffer. Draw a circle with 1 km radius
nr = 500 # n. of points
r = 1000 #input$buf1 # radius
buf1 = seq(0, 2 * pi, length.out = nr)
xy = cbind(x + r * sin(buf1), y + r * cos(buf1))

# Create the spatial object
buf_sp1 = SpatialPolygons(
  list(Polygons(
  list(Polygon(xy)), "1km")))
proj4string(buf_sp1) <- CRS("+init=epsg:3021")

#  Buffer. Draw a circle with 3 km radius
nr3 = 500 # n. of points
r3 = 3000 #input$buf2  # radius
buf3 = seq(0, 2 * pi, length.out = nr3)
xz = cbind(x + r3 * sin(buf3), y + r3 * cos(buf3))

# Create a "donut" insted of a buffer. 1 km is a hole in the 3 km buffer 
buf_sp3 = SpatialPolygons(
  list(Polygons(
  list(Polygon(xz, hole = F), Polygon(xy, hole = T)), "3km")))
proj4string(buf_sp3) <- CRS("+init=epsg:3021")

# Buffer. Draw a circle with 10 km radius
nr10 = 500 # n. of points
r10 = 10000 #input$buf3  # radius
buf10 = seq(0, (2 * pi), length.out = nr10)
yz = cbind(x + r10 * sin(buf10), y + r10 * cos(buf10))

# Create a "donut" insted of a buffer. 3km is a hole in the 10km buffer
buf_sp10 = SpatialPolygons(
          list(Polygons(
          list(Polygon(yz, hole = F), Polygon(xz, hole = T)), "10km" )))
proj4string(buf_sp10) <- CRS("+init=epsg:3021")

```


```{r FarmsInBuffers, results='asis', echo=FALSE}

# Spatial subset of farms in each buffer. When no farms inside buffers it gives back just the outbreak (to avoid an error in leafletR). Check if can be fixed using leaflet library

if(all(is.na(over(farms_RT90, buf_sp10)))) {
  
  farms_in10_RT90 <- outbreak1
  
} else {
  
  farms_in10_RT90 <- farms_RT90[buf_sp10, c(1,4,8,11,41)]
}

if(all(is.na(over(farms_RT90, buf_sp3)))) {
  
  farms_in3_RT90 <- outbreak1

} else {
  
  farms_in3_RT90 <- farms_RT90[buf_sp3, c(1,4,8,11,41)]
}

if(sum(!is.na(over(farms_RT90, buf_sp1))) == 0 |
   sum(!is.na(over(farms_RT90, buf_sp1))) == 1) {
  
  farms_in1_RT90 <- outbreak1
  
} else {
  
  farms_in1_RT90 <- farms_RT90[buf_sp1, c(1,4,8,11,41)]
  farms_in1_RT90 <- farms_in1_RT90[farms_in1_RT90@data$Ppn != ppn,]
}
```


```{r PlotMap2, fig.width=14, fig.height=14, echo=FALSE, warning=FALSE, message=FALSE}

plot(buf_sp10, axes = T, col = rgb(0,1,0, alpha = 0.3), lty=5, lwd = 2)
plot(buf_sp3, add = T, col = rgb(1,1,0, alpha = 0.3), lty=3, lwd = 2)
plot(buf_sp1, add = T, col = rgb(1,0,0, alpha = 0.3), lty = 2, lwd = 2)
plot(outbreak, add = T, col = "black", pch = 19, cex = 1)

if(!identical(farms_in10_RT90, outbreak1)) {
  if(nrow(farms_in10_RT90@data) == 1) {
    invisible(text(coordinates(farms_in10_RT90),
                   labels = as.character(farms_in10_RT90@data$Ppn),
                   cex = 0.6,
                   pos = 1,
                   offset = 1))
    
} else {
  
  textplot(coordinates(farms_in10_RT90)[, 1],
           coordinates(farms_in10_RT90)[, 2],
           as.character(farms_in10_RT90@data$Ppn),
           cex = 0.7,
           new = FALSE)
  
  plot(farms_in10_RT90, add = T, col = "green", bg = "black", pch = 19, cex = 0)
  
  }
}

if(!identical(farms_in3_RT90, outbreak1)) {
  if(nrow(farms_in3_RT90@data) == 1) {
   invisible(text(coordinates(farms_in3_RT90),
                  labels = as.character(farms_in3_RT90@data$Ppn),
                  cex = 0.7))
} else {
  
  textplot(coordinates(farms_in3_RT90)[, 1],
           coordinates(farms_in3_RT90)[, 2],
           as.character(farms_in3_RT90@data$Ppn),
           cex = 0.7,
           new = FALSE)

  plot(farms_in3_RT90, add = T, bg = "yellow", pch = 19, cex = 0)

  }
}


if(!identical(farms_in1_RT90, outbreak1)) {
  if(nrow(farms_in1_RT90@data) == 1) {
    invisible(text(coordinates(farms_in1_RT90),
                   labels = as.character(farms_in1_RT90@data$Ppn),
                   cex = 0.7))
} else {
  
  textplot(coordinates(farms_in1_RT90)[, 1],
           coordinates(farms_in1_RT90)[, 2],
           as.character(farms_in1_RT90@data$Ppn),
           cex = 0.7,
           new = FALSE)
  
  plot(farms_in1_RT90, add = T, bg = "red", pch = 19, cex = 0)

  }
}

legend("topright", cex = 1,
       c("Buffer 10 km", "Buffer 3 km", "Buffer 1 km"),
       pch = c(21, 21, 21), pt.cex = 0,
       fill = c("green", "yellow", "red"), bty = "n")

title(expression(paste("Restriction Zones: PPNs within buffer areas of 1, 3 and 10 km radius")))

```

****

<br>

```{r LeafletMap2, results='asis',echo=FALSE, warning=FALSE, message=FALSE, fig.width=9, fig.align='center'}

outbreak2 <- spTransform(outbreak1, CRS("+init=epsg:4326"))

# Buffer1km
buf_sp1_84 <- spTransform(buf_sp1, CRS("+init=epsg:4326"))
buf_spdf1_84 <- SpatialPolygonsDataFrame(buf_sp1_84,
                                       data.frame(N = "Restriction_zone_1km",
                                                  row.names = "1km"))

# Buffer3km
buf_sp3_84 <- spTransform(buf_sp3, CRS("+init=epsg:4326"))
buf_spdf3_84 <- SpatialPolygonsDataFrame(buf_sp3_84,
                                       data.frame(N="Restriction_zone_3km",
                                                  row.names="3km"))

# Buffer10km
buf_sp10_84 <- spTransform(buf_sp10, CRS("+init=epsg:4326"))
buf_spdf10_84 <- SpatialPolygonsDataFrame(buf_sp10_84,
                                       data.frame(N="Restriction_zone_10km",
                                                  row.names="10km"))


# farms within 1 km buffer
farms_in1_84 <- spTransform(farms_in1_RT90, 
                     CRS("+init=epsg:4326"))


# farms within 3 km buffer
farms_in3_84 <- spTransform(farms_in3_RT90, 
                     CRS("+init=epsg:4326"))


# farms within 10 km buffer
farms_in10_84 <- spTransform(farms_in10_RT90, 
                     CRS("+init=epsg:4326"))


# final map

LeafletMap2 <- leaflet() %>% addProviderTiles("CartoDB.Positron")

LeafletMap2 %>%
  
  addCircleMarkers(data = farms_in10_84,
                   stroke = FALSE,
                   fill = TRUE,
                   fillColor = "green") %>%
  
  addCircleMarkers(data = farms_in3_84,
                   stroke = FALSE,
                   fill = TRUE,
                   fillColor = "yellow") %>%
  
  addCircleMarkers(data = farms_in1_84,
                   stroke = FALSE,
                   fill = TRUE,
                   fillColor = "red") %>%

  
  addPolygons(data = buf_spdf10_84, color = "green", fill = "green") %>%
  addPolygons(data = buf_spdf3_84, color = "yellow", fill = "yellow") %>%
  addPolygons(data = buf_spdf1_84, color = "red", fill = "red") %>%

  addCircleMarkers(data = outbreak2,
                   stroke = FALSE,
                   fill = TRUE,
                   fillColor = "black",
                   fillOpacity = 1) 

```

****

<br>

### 6. SUMMARY STATISTICS FOR PPNs WITHIN RESTICTION ZONES

* There are __`r if(!identical(farms_in1_RT90,outbreak1)){sum(nrow(farms_in1_RT90@data))}else{"0"}`__ PPNs in 1 km radius from the position of the investigaed PPN 
<br>
* There are __`r if(!identical(farms_in3_RT90,outbreak1)){sum(nrow(farms_in3_RT90@data))}else{"0"}`__ PPNs in 3 km radius from the position of the investigaed PPN
<br>
* There are __`r if(!identical(farms_in10_RT90,outbreak1)){sum(nrow(farms_in10_RT90@data))}else{"0"}`__ PPNs in 10 km radius from the position of the investigaed PPN

<br>

```{r SumAnimal,results='asis',echo=FALSE}

#duplicated PPN records for total herds/farms/animal calculation

if(!identical(farms_in1_RT90, outbreak1)) {
  
  n.PPN.in1 <- PPN[which(PPN$Ppn %in% farms_in1_RT90@data$Ppn),]
}

if(!identical(farms_in3_RT90, outbreak1)) {
  
  n.PPN.in3 <- PPN[which(PPN$Ppn %in% farms_in3_RT90@data$Ppn),]
}

if(!identical(farms_in10_RT90, outbreak1)){
  
  n.PPN.in10 <- PPN[which(PPN$Ppn %in% farms_in10_RT90@data$Ppn),]
}


sum_anim <- function(n.PPN.in) {
  
  n.anim <- n.PPN.in[,c("Antal",
                        "Antalslaktplatser",
                        "Antalsuggplatser",
                        "CDB.Antal",
                        "Maxkapacitet")]
  
  ani_sum <- apply (n.anim, 1, FUN = sum, na.rm = T)
  
  n.PPN.in <- cbind (n.PPN.in, ani_sum)
  
return (n.PPN.in)

}

if(!identical(farms_in1_RT90, outbreak1)) {
  
  n.PPN.in1 <- sum_anim(n.PPN.in1)
  
}

if(!identical(farms_in3_RT90, outbreak1)) {
  
n.PPN.in3 <- sum_anim(n.PPN.in3)

}

if(!identical(farms_in10_RT90, outbreak1)) {
  
n.PPN.in10 <- sum_anim(n.PPN.in10)

}

# Exclusion of duplicated values when Djurhållare== DJURINNEHAVARE (to sum properly)

if(!identical(farms_in1_RT90,outbreak1)) {
  
  n.PPN.in1 <- n.PPN.in1[!duplicated(n.PPN.in1[c("Ppn",
                                                 "Adress",
                                                 "Typ",
                                                 "Typ.1",
                                                 "tot_anim")]),]
}

if(!identical(farms_in3_RT90, outbreak1)) {
  
  n.PPN.in3 <- n.PPN.in3[!duplicated(n.PPN.in3[c("Ppn",
                                                 "Adress",
                                                 "Typ",
                                                 "Typ.1",
                                                 "tot_anim")]),]

}

if(!identical(farms_in10_RT90, outbreak1)) {
  
n.PPN.in10 <- n.PPN.in10[!duplicated(n.PPN.in10[c("Ppn",
                                                  "Adress",
                                                  "Typ",
                                                  "Typ.1",
                                                  "tot_anim")]),]
}

```

#### 6.1 SUMMARY STATISTICS FOR PPNs WITHIN 1 KM RADIUS

Total number of herds/animals per species belonging to PPNs inside the radius of __1km__ are showed in the graph: 

```{r herds/animIn1km, results='asis', fig.height=4, fig.width=12, echo=FALSE}

if(!identical(farms_in1_RT90, outbreak1)) {
      
      counts <- table(n.PPN.in1$Typ)
      
      counts2 <-tapply(n.PPN.in1$ani_sum, 
                       INDEX = n.PPN.in1$Typ,
                       FUN=sum)
      
      width = ifelse(length(counts) == 1, 0.2, 0.6)
      
      par(mfrow = c(1,2), las = 2)
      
      b1a <- barplot(counts,
                     main="Number of herds by species",
                     ylab = "Number of herds",
                     ylim = c(0, max(counts * 1.4)),
                     xlim = c(0, length(counts)),
                     width = width)
      
      text(x = b1a, y = counts, label = counts, 
           pos = 3, cex = 0.8, col = "black")
      
      b1b <- barplot(counts2,
                     main = "Number of animals by species",
                     ylab = "Number of animals",
                     ylim = c(0, max(counts2 * 1.4)),
                     xlim = c(0, length(counts2)),
                     width = width)
      
      text(x = b1b, y = counts2, label = counts2,
           pos = 3, cex = 0.8, col = "black")
      
} else {
      
     cat("* **No PPNs other than the investigated PPN within the  radius of 1 km**")
}
```

<br>

#### 6.2 SUMMARY STATISTICS FOR PPNs WITHIN 3 KM RADIUS

Total number of herds/animals per species belonging to PPNs inside the radius of __3km__ are showed in the graph:  

```{r herds/animIn3km,results='asis',fig.height=4, fig.width=12, echo=FALSE}

if(!identical(farms_in3_RT90, outbreak1)) {
      
      counts<- table(n.PPN.in3$Typ)
      
      counts2<-tapply(n.PPN.in3$ani_sum,
                      INDEX = n.PPN.in3$Typ,
                      FUN = sum)
      
      width = ifelse(length(counts) == 1, 0.2, 0.8)
      
      par(mfrow = c(1,2), mar = c(5.1, 4.8, 4.1, 2.1),
          mgp = c(3.8, 1, 0), las=2)
      
      b3a <- barplot(counts, 
                     main = "Number of herds by species",
                     ylab = "Number of herds",
                     ylim = c(0, max(counts * 1.4)),
                     xlim = c(0, length(counts)),
                     width = width)
      
      text(x = b3a, y = counts, label = counts, 
           pos = 3, cex = 0.8, col = "black",)
      
      b3b <- barplot(counts2,
                     main = "Number of animals by species",
                     ylab = "Number of animals",
                     ylim = c(0, max(counts2 * 1.4)),
                     xlim = c(0, length(counts2)),
                     width = width)
      
      text(x = b3b, y = counts2, label = counts2, 
           pos = 3, cex = 0.8, col = "black",)

} else {
      
     cat("* **No PPNs other than the investigated PPN within the radius of 3 km**")
}
```

<br>

#### 6.3 SUMMARY STATISTICS FOR PPNs WITHIN 10 KM RADIUS

Total number of herds/animals per species belonging to PPNs inside the radius of __10km__ are showed in the graph: 

```{r herds/animIn10km,results='asis',fig.height=4, fig.width=12, echo=FALSE}

if(!identical(farms_in10_RT90, outbreak1)) {
  
  counts <- table(n.PPN.in10$Typ)
  
  counts2 <- tapply(n.PPN.in10$ani_sum,
                        INDEX=n.PPN.in10$Typ,
                        FUN=sum)
  
  width = ifelse(length(counts) == 1, 0.2, 0.8)
  
  par(mfrow = c(1, 2), mar = c(5.1, 4.8, 4.1, 2.1),
      mgp = c(3.8, 1, 0), las = 2)
  
  b10a <- barplot(counts,
                  main = "Number of herds by species",
                  ylab = "Number of herds",
                  ylim = c(0, max(counts * 1.4)),
                  xlim = c(0, length(counts)),
                  width = width)
  
  text(x = b10a, y = counts, label = counts, 
           pos = 3, cex = 0.8, col = "black",)
  
  b10b <- barplot(counts2,
                  main = "Number of animals by species",
                  ylab = "Number of animals",
                  ylim = c(0, max(counts2 * 1.8)),
                  xlim = c(0, length(counts2)),
                  width = width)
  
  text(x = b10b, y = counts2, label = counts2, 
           pos = 3, cex = 0.8, col = "black",)

} else {
      
     cat("* **No PPNs other than the investigated PPN within the radius of 10 km**")
}
```

****

<br>
